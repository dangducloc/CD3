##############################################################################
# CUSTOM MODSECURITY RULES – SECURE FILE UPLOAD
# Compatible: OWASP CRS 3.x + nginx/apache
##############################################################################

# ==============================
# BẬT ENGINE + REQUEST BODY
# ==============================
SecRuleEngine On
SecRequestBodyAccess On
SecRequestBodyLimit 134217728
SecRequestBodyNoFilesLimit 262144

SecTmpDir /tmp
SecDataDir /tmp

# allow multipart/form-data
SecRule REQUEST_HEADERS:Content-Type "multipart/form-data" \
    "id:900000,\
     phase:1,\
     pass,\
     nolog"

##############################################################################

# Turn off rule that block file upload based on extension
SecRule REQUEST_URI "@beginsWith /upload" \
    "id:900006,\
     phase:1,\
     pass,\
     nolog,\
     ctl:ruleRemoveById=933110,\
     ctl:ruleRemoveById=944140"

# Fuck these rules
SecRule REQUEST_URI "@beginsWith /upload" \
    "id:900001,\
     phase:1,\
     pass,\
     nolog,\
     ctl:ruleRemoveById=920100,\
     ctl:ruleRemoveById=920160,\
     ctl:ruleRemoveById=920170,\
     ctl:ruleRemoveById=920180,\
     ctl:ruleRemoveById=920190,\
     ctl:ruleRemoveById=920200,\
     ctl:ruleRemoveById=920210,\
     ctl:ruleRemoveById=920220,\
     ctl:ruleRemoveById=920230,\
     ctl:ruleRemoveById=920240,\
     ctl:ruleRemoveById=920270,\
     ctl:ruleRemoveById=920280,\
     ctl:ruleRemoveById=920300,\
     ctl:ruleRemoveById=920310,\
     ctl:ruleRemoveById=920320,\
     ctl:ruleRemoveById=920330,\
     ctl:ruleRemoveById=920340,\
     ctl:ruleRemoveById=920350,\
     ctl:ruleRemoveById=920360,\
     ctl:ruleRemoveById=920370,\
     ctl:ruleRemoveById=920380,\
     ctl:ruleRemoveById=920390,\
     ctl:ruleRemoveById=920400,\
     ctl:ruleRemoveById=920410,\
     ctl:ruleRemoveById=920420,\
     ctl:ruleRemoveById=920430,\
     ctl:ruleRemoveById=920440,\
     ctl:ruleRemoveById=920450,\
     ctl:ruleRemoveById=920460,\
     ctl:ruleRemoveById=920470"

##############################################################################
# check file extension 

SecRule FILES "@rx (?i)\.(php[3-7]?|phtml|phar|asp|aspx|jsp|exe|bat|sh|dll|pl|cgi|py|rb|go|jar|war|ear|ini|cfg|env|htaccess|bak|log|inc)$" \
    "id:900002,\
     phase:2,\
     deny,\
     status:403,\
     log,\
     msg:'[CUSTOM] Blocked dangerous file extension',\
     tag:'upload/blocked-extension'"

##############################################################################
# allow only image file extensions

SecRule FILES "!@rx (?i)\.(jpg|jpeg|png|gif|webp|bmp)$" \
    "id:900003,\
     phase:2,\
     deny,\
     status:403,\
     log,\
     msg:'[CUSTOM] Only image files allowed',\
     tag:'upload/whitelist'"

##############################################################################
# Fuckin the fake magic byte check

SecRule FILES_TMPNAMES "@inspectFile /usr/share/misc/magic.mgc" \
    "id:900004,\
     phase:2,\
     deny,\
     status:403,\
     log,\
     msg:'[CUSTOM] Invalid image content (magic check)',\
     tag:'upload/magic-byte'"

##############################################################################
# size limit 

SecRule FILES_COMBINED_SIZE "@gt 10485760" \
    "id:900005,\
     phase:2,\
     deny,\
     status:413,\
     log,\
     msg:'[CUSTOM] Uploaded file too large',\
     tag:'upload/size-limit'"
