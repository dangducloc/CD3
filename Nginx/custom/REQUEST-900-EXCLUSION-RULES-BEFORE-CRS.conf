
SecRuleEngine On
SecRequestBodyAccess On

SecRequestBodyLimit 134217728

SecRequestBodyNoFilesLimit 262144

SecTmpDir /tmp
SecDataDir /tmp

# dont keep temp files
SecUploadKeepFiles Off

# allow multipart/form-data

SecRule REQUEST_HEADERS:Content-Type "@contains multipart/form-data" \
    "id:900000,\
     phase:1,\
     pass,\
     nolog"

# marki upload request

SecRule REQUEST_URI "@beginsWith /upload" \
    "id:900010,\
     phase:1,\
     pass,\
     nolog,\
     setvar:tx.is_upload=1"

# block multidot
SecRule FILES "@rx \.(.*\.){1,}" \
    "id:900071,\
     phase:2,\
     t:lowercase,\
     deny,\
     status:403,\
     log,\
     msg:'[UPLOAD] multidot',\
     tag:'upload/multi-dot-any'"

# block webshell
SecRule REQUEST_BODY "@rx (?i)(<%|Runtime\.getRuntime|ProcessBuilder|<\?php|eval\s*\(|system\s*\()" \
"id:910101,\
phase:2,\
deny,\
status:403,\
log ,\
msg:'[UPLOAD] Webshell code inside uploaded file',\
tag:'upload/webshell/body'"


# block ext
SecRule FILES "@rx (?i)\.(php[3-7]?|phtml|phar|asp|aspx|jsp|exe|bat|sh|dll|pl|cgi|py|rb|go|jar|war|ear|ini|cfg|env|htaccess|bak|log|inc)$" \
    "id:900020,\
     phase:2,\
     deny,\
     status:403,\
     log,\
     msg:'[UPLOAD] block ext sus',\
     tag:'upload/extension'"

# Whitelist: Chỉ cho phép hình ảnh
SecRule FILES "!@rx (?i)\.(jpg|jpeg|png|gif|webp|bmp)$" \
    "id:900021,\
     phase:2,\
     deny,\
     status:403,\
     log,\
     msg:'[UPLOAD] image only',\
     tag:'upload/whitelist'"


# web size limit (10MB)
SecRule FILES_COMBINED_SIZE "@gt 10485760" \
    "id:900040,\
     phase:2,\
     deny,\
     status:413,\
     log,\
     msg:'[UPLOAD] too big(>10MB)',\
     tag:'upload/size'"


